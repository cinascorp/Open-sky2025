<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Flight Tracker - Enhanced</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- OpenLayers CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.4.0/ol.css">
    
    <!-- Google Maps API -->
    <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA6myHzS10YXdcazAFalmXvDkrYCp5cLc8&v=beta&libraries=maps3d"></script>
    
    <!-- Three.js -->
    <script src="https://unpkg.com/three@0.158.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.158.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://unpkg.com/three@0.158.0/examples/js/controls/OrbitControls.js"></script>
    
    <style>
        :root {
            --bg: #ffffff;
            --panel: #253c63;
            --text: #ffd400;
            --border: #333a42;
            --muted: #9aa2aa;
            --country: #90ee90; 
            --province: #ff69b4; 
            --road: #8fd3ff;
            --mil: #4b1313;
            --passenger: #ffe34d; 
            --commercial: #4dacff; 
            --private1: #b56dff; 
            --droneLow: #d21674; 
            --droneHigh: #ff0000; 
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        #map {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        /* 3D Map Container */
        #map3d-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: none;
            z-index: 1000;
        }

        gmp-map-3d {
            width: 100%;
            height: 100%;
        }

        /* Three.js overlay for 3D models */
        #three-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1001;
        }

        /* Control buttons */
        .control-btn {
            position: fixed;
            z-index: 1100;
            background: var(--panel);
            border: 1px solid var(--border);
            color: var(--text);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            background: var(--text);
            color: var(--panel);
        }

        #menuToggle {
            top: 8px;
            right: 10px;
        }

        #mapLayerToggle {
            top: 60px;
            left: 10px;
        }

        #view3DToggle {
            top: 110px;
            left: 10px;
        }

        #openskyToggle {
            top: 160px;
            left: 10px;
        }

        /* 3D Controls Panel */
        #controls3d {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(37, 60, 99, 0.95);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            color: var(--text);
            z-index: 1101;
            display: none;
            min-width: 250px;
        }

        #controls3d h6 {
            margin-bottom: 10px;
            color: var(--text);
        }

        #controls3d .form-control, #controls3d .form-select {
            background: #435a76;
            color: var(--text);
            border-color: var(--border);
            margin-bottom: 8px;
        }

        #controls3d .btn {
            margin: 2px;
        }

        /* Offcanvas menu */
        .offcanvas-end {
            background: var(--panel);
            border-left: 1px solid var(--border);
            color: var(--text);
        }

        .offcanvas-end .form-select, .offcanvas-end .form-control, .offcanvas-end .form-check-input {
            background: #435a76;
            color: var(--text);
            border-color: var(--border);
        }

        .offcanvas-end .table {
            color: var(--text);
        }

        .offcanvas-end .table thead th {
            border-bottom-color: var(--border);
        }

        .offcanvas-end .table td, .offcanvas-end .table th {
            border-color: var(--border);
        }

        /* Popup styles */
        #popup {
            position: absolute;
            font-size: 11px;
            background: rgba(15,20,27,0.98);
            border: 1px solid var(--border);
            padding: .5rem .75rem;
            border-radius: .5rem;
            min-width: 240px;
            color: var(--text);
            z-index: 900;
            display: none;
        }

        #popup-closer { 
            cursor: pointer; 
            float: right; 
        }

        .small-muted { 
            color: var(--muted); 
            font-size: .85rem; 
        }

        /* Legend */
        .legend {
            position: fixed;
            left: 10px;
            bottom: 10px;
            z-index: 1000;
            background: rgba(15,20,27,0.9);
            border: 1px solid var(--border);
            border-radius: .5rem;
            padding: .5rem .75rem;
            font-size: .9rem;
        }

        .legend .item {
            display: flex; 
            align-items: center;
            gap: .4rem;
            margin: .2rem 0;
        }

        .legend .swatch { 
            width: 16px; 
            height: 16px; 
            border-radius: 3px; 
            display: inline-block; 
        }

        .spectrum-bar { 
            width: 120px; 
            height: 16px; 
            border-radius: 3px; 
            display: inline-block;
            background: linear-gradient(to right,#FF0000, #FFA500, #FFFF00, #00FF00, #0000FF, #4B0082, #800080); 
        }

        /* Responsive */
        @media (max-width: 768px) {
            .offcanvas-end {
                width: 80vw !important;
            }
            #controls3d {
                min-width: 200px;
                right: 5px;
            }
        }
    </style>
</head>
<body>
    <!-- Control Buttons -->
    <button id="menuToggle" class="control-btn" data-bs-toggle="offcanvas" data-bs-target="#rightMenu" aria-controls="rightMenu" aria-expanded="false">
        <span id="menuToggleIcon">&lt;</span>
    </button>
    
    <button id="mapLayerToggle" class="control-btn" title="Toggle Map Layer">L</button>
    
    <button id="view3DToggle" class="control-btn" title="Toggle 3D View">3D</button>
    
    <button id="openskyToggle" class="control-btn" title="Toggle OpenSky Data">OS</button>

    <!-- 2D Map Container -->
    <div id="map"></div>

    <!-- 3D Map Container -->
    <div id="map3d-container">
        <gmp-map-3d id="map3d"
                    mode="hybrid"
                    center="37.7469897,48.7537908,226"
                    range="20000"
                    tilt="75"
                    heading="45">
        </gmp-map-3d>
        <div id="three-overlay"></div>
    </div>

    <!-- 3D Controls Panel -->
    <div id="controls3d">
        <h6>3D Flight Controls</h6>
        <div class="mb-2">
            <label class="form-label small">Camera Mode</label>
            <select id="cameraMode" class="form-select form-select-sm">
                <option value="orbit">Orbit</option>
                <option value="follow">Follow Aircraft</option>
                <option value="free">Free Camera</option>
            </select>
        </div>
        <div class="mb-2">
            <label class="form-label small">Model Scale</label>
            <input type="range" id="modelScale" class="form-range" min="0.1" max="2" step="0.1" value="1">
            <small class="text-muted">Scale: <span id="scaleValue">1.0</span></small>
        </div>
        <div class="mb-2">
            <button id="resetCamera" class="btn btn-sm btn-outline-warning">Reset Camera</button>
            <button id="toggleModels" class="btn btn-sm btn-outline-info">Toggle Models</button>
        </div>
        <div class="mb-2">
            <label class="form-label small">Selected Aircraft</label>
            <div id="selectedAircraft" class="small text-muted">None</div>
        </div>
    </div>

    <!-- Popup -->
    <div id="popup">
        <div>
            <span id="popup-closer">âœ•</span>
        </div>
        <div id="popup-content"></div>
    </div>

    <!-- Right Menu -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="rightMenu" aria-labelledby="rightMenuLabel">
        <div class="offcanvas-header">
            <h5 id="rightMenuLabel">Settings & Information</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <div class="mb-3">
                <label class="form-label">Flight Group</label>
                <select id="groupSelect" class="form-select"></select>
                <div class="form-text text-warning">Groups of ~1000 flights (A, B, C... AA, AB...)</div>
            </div>
            
            <div class="row g-2 align-items-center mb-3">
                <div class="col-auto">
                    <button id="refreshBtn" class="btn btn-outline-warning btn-sm">Refresh now</button>
                </div>
                <div class="col-auto form-check form-switch">
                    <input class="form-check-input" type="checkbox" role="switch" id="autoUpdateSwitch" checked>
                    <label class="form-check-label" for="autoUpdateSwitch">Auto update (5s)</label>
                </div>
                <div class="col-auto form-check form-switch">
                    <input class="form-check-input" type="checkbox" role="switch" id="useProxySwitch" checked>
                    <label class="form-check-label" for="useProxySwitch">Use CORS proxy</label>
                </div>
            </div>

            <div class="mb-3">
                <h6 class="mb-2">Information</h6>
                <table class="table table-sm align-middle">
                    <tbody>
                        <tr><th scope="row">Total flights (repository)</th><td id="totalFlights">â€”</td></tr>
                        <tr><th scope="row">Passenger flights</th><td id="countPassenger">â€”</td></tr>
                        <tr><th scope="row">Commercial (other)</th><td id="countCommercial">â€”</td></tr>
                        <tr><th scope="row">Private flights</th><td id="countPrivate1">â€”</td></tr>
                        <tr><th scope="row">Helicopters</th><td id="countHeli">â€”</td></tr>
                        <tr><th scope="row">Military flights</th><td id="countMilitary">â€”</td></tr>
                        <tr><th scope="row">Drones</th><td id="countDrones">â€”</td></tr>
                        <tr><th scope="row">OpenSky flights</th><td id="countOpenSky">â€”</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="mb-3">
                <h6 class="mb-2">Color and Symbol Guide</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead><tr><th>Type</th><th>Color</th><th>Symbol</th></tr></thead>
                        <tbody>
                            <tr><td>Military</td><td><span class="swatch" style="background: var(--mil); width: 20px; height: 20px; display: inline-block; border-radius: 3px;"></span></td><td>Fighter Jet Icon (red)</td></tr>
                            <tr><td>Manned (nonâ€‘military)</td><td><span class="spectrum-bar"></span></td><td>Airplane Icon</td></tr>
                            <tr><td>Helicopter</td><td><span class="swatch" style="background: var(--passenger); width: 20px; height: 20px; display: inline-block; border-radius: 3px;"></span></td><td>Helicopter Icon</td></tr>
                            <tr><td>Drone</td><td><span class="swatch" style="background: var(--droneLow); width: 20px; height: 20px; display: inline-block; border-radius: 3px;"></span></td><td>Drone Icon</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Legend -->
    <div class="legend">
        <div class="item">
            <span class="swatch" style="background: var(--mil);"></span>
            <span>Military</span>
        </div>
        <div class="item">
            <span class="spectrum-bar"></span>
            <span>Altitude Spectrum</span>
        </div>
        <div class="item">
            <span class="swatch" style="background: var(--passenger);"></span>
            <span>Helicopter</span>
        </div>
        <div class="item">
            <span class="swatch" style="background: var(--droneLow);"></span>
            <span>Drone</span>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ol@v7.4.0/dist/ol.js"></script>

    <script>
        (function() {
            // Global variables
            let map, map3d, threeScene, threeCamera, threeRenderer, threeControls;
            let aircraftModels = new Map();
            let selectedAircraft = null;
            let is3DMode = false;
            let isOpenSkyEnabled = false;
            let openSkyData = new Map();
            let flightsByHex = new Map();
            let tracksByHex = new Map();
            let selectedFlights = new Set();
            let currentGroup = 'A';
            let sortedHexes = [];
            let lastFullCount = 0;
            let autoUpdateTimer = null;

            // UI elements
            const mapContainer = document.getElementById('map');
            const map3dContainer = document.getElementById('map3d-container');
            const threeOverlay = document.getElementById('three-overlay');
            const view3DToggle = document.getElementById('view3DToggle');
            const openskyToggle = document.getElementById('openskyToggle');
            const controls3d = document.getElementById('controls3d');
            const cameraMode = document.getElementById('cameraMode');
            const modelScale = document.getElementById('modelScale');
            const scaleValue = document.getElementById('scaleValue');
            const resetCamera = document.getElementById('resetCamera');
            const toggleModels = document.getElementById('toggleModels');
            const selectedAircraftEl = document.getElementById('selectedAircraft');

            // Initialize the application
            init();

            function init() {
                init2DMap();
                init3DMap();
                initThreeJS();
                initEventListeners();
                initUI();
                startDataFetching();
            }

            function init2DMap() {
                const TILE_URLS = [
                    'https://{a-c}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
                    'https://{a-c}.tile.openstreetmap.org/{z}/{x}/{y}.png'
                ];

                const baseLayer = new ol.layer.Tile({
                    source: new ol.source.XYZ({ 
                        url: TILE_URLS[0], 
                        attributions: 'Â© OpenStreetMap, Â© Carto' 
                    })
                });

                baseLayer.getSource().on('tileloaderror', () => {
                    baseLayer.setSource(new ol.source.OSM());
                });

                const trackLayer = new ol.layer.Vector({ 
                    source: new ol.source.Vector(),
                    name: 'tracks'
                });
                const markerLayer = new ol.layer.Vector({ 
                    source: new ol.source.Vector(),
                    name: 'markers'
                });
                const selectedFlightLayer = new ol.layer.Vector({ 
                    source: new ol.source.Vector(),
                    name: 'selected'
                });

                map = new ol.Map({
                    target: 'map',
                    layers: [baseLayer, trackLayer, markerLayer, selectedFlightLayer],
                    view: new ol.View({ 
                        center: ol.proj.fromLonLat([52.600, 36.500]), 
                        zoom: 4, 
                        minZoom: 1, 
                        maxZoom: 18 
                    })
                });

                // Popup setup
                const popupEl = document.getElementById('popup');
                const popupCloser = document.getElementById('popup-closer');
                const popup = new ol.Overlay({ 
                    element: popupEl, 
                    autoPan: { animation: { duration: 250 } } 
                });
                map.addOverlay(popup);

                popupCloser.addEventListener('click', () => { 
                    popup.setPosition(undefined); 
                    popupEl.style.display = 'none'; 
                });

                // Map click handler
                map.on('singleclick', (evt) => {
                    map.forEachFeatureAtPixel(evt.pixel, (feature, layer) => {
                        if (layer !== markerLayer) return;
                        const flightData = feature.get('data');
                        if (!flightData) return;
                        
                        showFlightPopup(flightData, evt.coordinate);
                        selectAircraft(flightData);
                    });
                });
            }

            function init3DMap() {
                // Wait for Google Maps to load
                const checkGoogleMaps = setInterval(() => {
                    if (window.google && window.google.maps) {
                        clearInterval(checkGoogleMaps);
                        
                        map3d = document.getElementById('map3d');
                        if (map3d) {
                            map3d.addEventListener('gmp-click', (event) => {
                                const lat = event.detail.latLng.lat;
                                const lng = event.detail.latLng.lng;
                                console.log('3D Map clicked:', lat, lng);
                            });
                        }
                    }
                }, 100);
            }

            function initThreeJS() {
                // Scene setup
                threeScene = new THREE.Scene();
                threeScene.fog = new THREE.Fog(0x87CEEB, 1000, 10000);

                // Camera setup
                threeCamera = new THREE.PerspectiveCamera(
                    60,
                    window.innerWidth / window.innerHeight,
                    0.1,
                    10000
                );
                threeCamera.position.set(0, 1000, 2000);

                // Renderer setup
                threeRenderer = new THREE.WebGLRenderer({ 
                    alpha: true, 
                    antialias: true 
                });
                threeRenderer.setSize(window.innerWidth, window.innerHeight);
                threeRenderer.setClearColor(0x000000, 0);
                threeRenderer.shadowMap.enabled = true;
                threeRenderer.shadowMap.type = THREE.PCFSoftShadowMap;
                threeOverlay.appendChild(threeRenderer.domElement);

                // Controls
                threeControls = new THREE.OrbitControls(threeCamera, threeRenderer.domElement);
                threeControls.enableDamping = true;
                threeControls.dampingFactor = 0.05;
                threeControls.maxPolarAngle = Math.PI / 2;
                threeControls.minDistance = 100;
                threeControls.maxDistance = 10000;

                // Lighting
                const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
                threeScene.add(ambientLight);

                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(1000, 1000, 1000);
                directionalLight.castShadow = true;
                directionalLight.shadow.mapSize.width = 2048;
                directionalLight.shadow.mapSize.height = 2048;
                threeScene.add(directionalLight);

                // Start animation loop
                animate();
            }

            function initEventListeners() {
                // Toggle buttons
                view3DToggle.addEventListener('click', toggle3DView);
                openskyToggle.addEventListener('click', toggleOpenSky);
                
                // 3D Controls
                cameraMode.addEventListener('change', updateCameraMode);
                modelScale.addEventListener('input', updateModelScale);
                resetCamera.addEventListener('click', resetCameraPosition);
                toggleModels.addEventListener('click', toggleAircraftModels);

                // Window resize
                window.addEventListener('resize', onWindowResize);

                // Menu toggle
                const menuToggleBtn = document.getElementById('menuToggle');
                const menuToggleIcon = document.getElementById('menuToggleIcon');
                menuToggleBtn.addEventListener('click', () => {
                    const expanded = menuToggleBtn.getAttribute('aria-expanded') === 'true';
                    menuToggleIcon.textContent = expanded ? '<' : '>';
                });

                // Other UI elements
                document.getElementById('refreshBtn').addEventListener('click', refreshData);
                document.getElementById('autoUpdateSwitch').addEventListener('change', toggleAutoUpdate);
                document.getElementById('groupSelect').addEventListener('change', (e) => {
                    currentGroup = e.target.value;
                    updateMarkersAndTracks();
                });
            }

            function initUI() {
                // Initialize group options
                setGroupOptions(28000);
                
                // Initialize scale display
                updateModelScale();
            }

            function toggle3DView() {
                is3DMode = !is3DMode;
                
                if (is3DMode) {
                    mapContainer.style.display = 'none';
                    map3dContainer.style.display = 'block';
                    controls3d.style.display = 'block';
                    view3DToggle.textContent = '2D';
                    view3DToggle.title = 'Switch to 2D View';
                    
                    // Sync camera position with 3D map
                    syncCameraWithMap();
                } else {
                    mapContainer.style.display = 'block';
                    map3dContainer.style.display = 'none';
                    controls3d.style.display = 'none';
                    view3DToggle.textContent = '3D';
                    view3DToggle.title = 'Switch to 3D View';
                }
            }

            function toggleOpenSky() {
                isOpenSkyEnabled = !isOpenSkyEnabled;
                openskyToggle.textContent = isOpenSkyEnabled ? 'OSâœ“' : 'OS';
                openskyToggle.title = isOpenSkyEnabled ? 'Disable OpenSky' : 'Enable OpenSky';
                
                if (isOpenSkyEnabled) {
                    fetchOpenSkyData();
                }
            }

            function updateCameraMode() {
                const mode = cameraMode.value;
                switch(mode) {
                    case 'orbit':
                        threeControls.enabled = true;
                        threeControls.autoRotate = false;
                        break;
                    case 'follow':
                        threeControls.enabled = false;
                        if (selectedAircraft) {
                            followAircraft(selectedAircraft);
                        }
                        break;
                    case 'free':
                        threeControls.enabled = true;
                        threeControls.autoRotate = false;
                        break;
                }
            }

            function updateModelScale() {
                const scale = parseFloat(modelScale.value);
                scaleValue.textContent = scale.toFixed(1);
                
                aircraftModels.forEach((model, hex) => {
                    model.scale.setScalar(scale);
                });
            }

            function resetCameraPosition() {
                threeCamera.position.set(0, 1000, 2000);
                threeCamera.lookAt(0, 0, 0);
                threeControls.reset();
            }

            function toggleAircraftModels() {
                const isVisible = aircraftModels.size > 0 && aircraftModels.values().next().value.visible;
                aircraftModels.forEach(model => {
                    model.visible = !isVisible;
                });
            }

            function syncCameraWithMap() {
                if (!map3d || !is3DMode) return;
                
                // Get current map center and sync with Three.js camera
                const center = map3d.center;
                if (center) {
                    const lat = center.lat;
                    const lng = center.lng;
                    const alt = center.alt || 1000;
                    
                    // Convert to Three.js coordinates
                    const x = (lng - 52.6) * 111000; // Rough conversion
                    const z = (lat - 36.5) * 111000;
                    const y = alt;
                    
                    threeCamera.position.set(x, y, z);
                    threeControls.target.set(x, 0, z);
                    threeControls.update();
                }
            }

            function selectAircraft(flightData) {
                selectedAircraft = flightData;
                selectedAircraftEl.textContent = flightData.callsign || flightData.hex || 'Unknown';
                
                if (is3DMode && cameraMode.value === 'follow') {
                    followAircraft(flightData);
                }
            }

            function followAircraft(flightData) {
                if (!flightData) return;
                
                const x = (flightData.lon - 52.6) * 111000;
                const z = (flightData.lat - 36.5) * 111000;
                const y = (flightData.alt_m || 0) + 500; // Follow from above
                
                threeCamera.position.set(x, y, z);
                threeControls.target.set(x, 0, z);
                threeControls.update();
            }

            function showFlightPopup(flightData, coordinate) {
                const popup = document.getElementById('popup');
                const popupContent = document.getElementById('popup-content');
                
                const category = categorizeFlight(flightData);
                const title = flightData.callsign || flightData.reg || flightData.hex;
                
                popupContent.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <strong>${title}</strong>
                        <span class="badge badge-outline">${category.toUpperCase()}</span>
                    </div>
                    <div class="small-muted">Hex: ${flightData.hex}${flightData.acType ? ' â€¢ Type: ' + flightData.acType : ''}</div>
                    <div>Lat: ${flightData.lat.toFixed(4)} â€¢ Lon: ${flightData.lon.toFixed(4)}</div>
                    <div>Alt: ${flightData.alt_m != null ? flightData.alt_m + ' m' : 'â€”'}</div>
                    <div>Speed: ${flightData.spd_kmh != null ? flightData.spd_kmh + ' km/h' : 'â€”'}</div>
                    <div>Heading: ${flightData.heading != null ? flightData.heading + 'Â°' : 'â€”'}</div>
                    <div class="mt-2">
                        <button class="btn btn-sm btn-outline-primary" onclick="selectAircraft('${flightData.hex}')">
                            View in 3D
                        </button>
                    </div>
                `;
                
                popup.style.display = 'block';
                
                // Update popup position
                const popupOverlay = map.getOverlays().getArray().find(o => o.getElement().id === 'popup');
                if (popupOverlay) {
                    popupOverlay.setPosition(coordinate);
                }
            }

            function categorizeFlight(flight) {
                if (isDrone(flight)) return 'drone';
                if (isHelicopter(flight)) return 'helicopter';
                if (isMilitary(flight)) return 'military';
                if (isPassenger(flight)) return 'passenger';
                if (isPrivate(flight)) return 'private';
                return 'commercial';
            }

            function isDrone(flight) {
                const spd = flight.spd_kmh || 0;
                const alt = flight.alt_m || 0;
                return (spd > 0 && spd <= 120) && (alt > 0 && alt <= 1200);
            }

            function isHelicopter(flight) {
                const spd = flight.spd_kmh || 0;
                const alt = flight.alt_m || 0;
                const looksHeli = flight.callsign && /(H|HELI|HEL|HEMS|MED|RESCUE)/i.test(flight.callsign);
                return (spd > 0 && spd < 260) && (alt > 0 && alt < 3000) && looksHeli;
            }

            function isMilitary(flight) {
                if (!flight.callsign) return false;
                const militaryPrefixes = ['RCH', 'QID', 'LAGR', 'NATO', 'PAT', 'BOMBER', 'B52', 'B1B', 'TEX', 'HURK', 'CFC', 'GAF', 'BAF', 'HAF', 'IAF', 'RFF', 'AF', 'ZZ', 'NAVY', 'USAF', 'RAF', 'RCAF', 'ARMY'];
                return militaryPrefixes.some(p => flight.callsign.toUpperCase().startsWith(p));
            }

            function isPassenger(flight) {
                return !!(flight.callsign && /^[A-Z]{2,3}\d{2,4}[A-Z]?$/.test(flight.callsign));
            }

            function isPrivate(flight) {
                if (!flight.callsign) return false;
                const privatePatterns = [/^N[0-9A-Z]{1,5}$/i, /^[A-Z]{1,2}-[A-Z]{3,5}$/i, /^RA-\d{4,}$/i];
                return privatePatterns.some(r => r.test(flight.callsign));
            }

            function createAircraftModel(flightData) {
                const loader = new THREE.GLTFLoader();
                
                // Choose model based on aircraft type
                let modelPath = './boeing-f18/scene.gltf'; // Default
                if (isHelicopter(flightData)) {
                    // Could use a helicopter model if available
                    modelPath = './boeing-f18/scene.gltf';
                } else if (isMilitary(flightData)) {
                    modelPath = './boeing-f18/scene.gltf'; // F-18 is military
                }

                loader.load(
                    modelPath,
                    (gltf) => {
                        const model = gltf.scene.clone();
                        
                        // Position the model
                        const x = (flightData.lon - 52.6) * 111000;
                        const z = (flightData.lat - 36.5) * 111000;
                        const y = flightData.alt_m || 0;
                        
                        model.position.set(x, y, z);
                        model.scale.setScalar(parseFloat(modelScale.value));
                        
                        // Rotate based on heading
                        if (flightData.heading) {
                            model.rotation.y = (flightData.heading * Math.PI) / 180;
                        }
                        
                        // Add to scene
                        threeScene.add(model);
                        aircraftModels.set(flightData.hex, model);
                        
                        // Add click handler
                        model.userData = { flightData };
                        model.traverse((child) => {
                            if (child.isMesh) {
                                child.userData = { flightData };
                            }
                        });
                    },
                    undefined,
                    (error) => {
                        console.error('Error loading aircraft model:', error);
                        // Create a simple box as fallback
                        createFallbackModel(flightData);
                    }
                );
            }

            function createFallbackModel(flightData) {
                const geometry = new THREE.BoxGeometry(20, 5, 50);
                const material = new THREE.MeshLambertMaterial({ 
                    color: getAircraftColor(flightData) 
                });
                const model = new THREE.Mesh(geometry, material);
                
                const x = (flightData.lon - 52.6) * 111000;
                const z = (flightData.lat - 36.5) * 111000;
                const y = flightData.alt_m || 0;
                
                model.position.set(x, y, z);
                model.scale.setScalar(parseFloat(modelScale.value));
                
                if (flightData.heading) {
                    model.rotation.y = (flightData.heading * Math.PI) / 180;
                }
                
                threeScene.add(model);
                aircraftModels.set(flightData.hex, model);
                model.userData = { flightData };
            }

            function getAircraftColor(flightData) {
                const category = categorizeFlight(flightData);
                switch(category) {
                    case 'military': return 0x4b1313;
                    case 'helicopter': return 0xffe34d;
                    case 'drone': return 0xd21674;
                    case 'passenger': return 0x4dacff;
                    case 'private': return 0xb56dff;
                    default: return 0x90ee90;
                }
            }

            function updateAircraftPositions() {
                aircraftModels.forEach((model, hex) => {
                    const flightData = flightsByHex.get(hex);
                    if (flightData) {
                        const x = (flightData.lon - 52.6) * 111000;
                        const z = (flightData.lat - 36.5) * 111000;
                        const y = flightData.alt_m || 0;
                        
                        model.position.set(x, y, z);
                        
                        if (flightData.heading) {
                            model.rotation.y = (flightData.heading * Math.PI) / 180;
                        }
                    }
                });
            }

            function removeAircraftModel(hex) {
                const model = aircraftModels.get(hex);
                if (model) {
                    threeScene.remove(model);
                    aircraftModels.delete(hex);
                }
            }

            function animate() {
                requestAnimationFrame(animate);
                
                if (threeControls) {
                    threeControls.update();
                }
                
                if (threeRenderer && threeScene && threeCamera) {
                    threeRenderer.render(threeScene, threeCamera);
                }
            }

            function onWindowResize() {
                if (threeCamera && threeRenderer) {
                    threeCamera.aspect = window.innerWidth / window.innerHeight;
                    threeCamera.updateProjectionMatrix();
                    threeRenderer.setSize(window.innerWidth, window.innerHeight);
                }
            }

            // Data fetching functions
            async function fetchOpenSkyData() {
                try {
                    const response = await fetch('https://opensky-network.org/api/states/all?lamin=-90&lamax=90&lomin=-180&lomax=180');
                    const data = await response.json();
                    
                    if (data.states) {
                        openSkyData.clear();
                        data.states.forEach(state => {
                            if (state[5] !== null && state[6] !== null) { // Valid lat/lon
                                const flightData = {
                                    hex: state[0],
                                    callsign: state[1],
                                    origin_country: state[2],
                                    time_position: state[3],
                                    last_contact: state[4],
                                    lon: state[5],
                                    lat: state[6],
                                    alt_m: state[7] ? state[7] * 0.3048 : null, // Convert feet to meters
                                    on_ground: state[8],
                                    velocity: state[9],
                                    heading: state[10],
                                    vertical_rate: state[11],
                                    sensors: state[12],
                                    baro_altitude: state[13],
                                    squawk: state[14],
                                    spi: state[15],
                                    position_source: state[16],
                                    category: state[17],
                                    spd_kmh: state[9] ? state[9] * 3.6 : null // Convert m/s to km/h
                                };
                                openSkyData.set(state[0], flightData);
                            }
                        });
                        
                        updateOpenSkyDisplay();
                    }
                } catch (error) {
                    console.error('Error fetching OpenSky data:', error);
                }
            }

            function updateOpenSkyDisplay() {
                document.getElementById('countOpenSky').textContent = openSkyData.size;
                
                if (is3DMode) {
                    // Add OpenSky aircraft to 3D scene
                    openSkyData.forEach((flightData, hex) => {
                        if (!aircraftModels.has(hex)) {
                            createAircraftModel(flightData);
                        }
                    });
                }
            }

            // FR24 data fetching (integrated from your existing code)
            async function fetchFR24Data() {
                const bounds = boundsFromView();
                let data;
                try {
                    data = await fetchFR24(bounds, document.getElementById('useProxySwitch').checked);
                } catch (e) {
                    console.warn('FR24 fetch error:', e);
                    return;
                }
                
                const parsed = parseFR24(data);
                lastFullCount = parsed.fullCount || lastFullCount;
                
                for (const f of parsed.flights) { 
                    flightsByHex.set(f.hex, f); 
                }
                
                sortedHexes = Array.from(flightsByHex.keys()).sort((a,b) => a.localeCompare(b));
                setGroupOptions(lastFullCount || sortedHexes.length);
                updateMarkersAndTracks();
                updateInfoTables(parsed.flights);
                
                // Update 3D models if in 3D mode
                if (is3DMode) {
                    update3DAircraft();
                }
            }

            // Helper functions from your existing code
            function boundsFromView() {
                const extent = map.getView().calculateExtent(map.getSize());
                const [minX, minY, maxX, maxY] = extent;
                const [minLon, minLat] = ol.proj.toLonLat([minX, minY]);
                const [maxLon, maxLat] = ol.proj.toLonLat([maxX, maxY]);
                return { minLat, maxLat, minLon, maxLon };
            }

            async function fetchFR24(bounds, useProxy = true) {
                const params = new URLSearchParams({
                    faa: '1', satellite: '1', mlat: '1', flarm: '1', adsb: '1', gnd: '1', air: '1', vehicles: '1', estimated: '1',
                    maxage: '14400', gliders: '1', stats: '1',
                    bounds: `${bounds.maxLat},${bounds.minLat},${bounds.minLon},${bounds.maxLon}`
                });
                
                const urls = [
                    `https://data-cloud.flightradar24.com/zones/fcgi/js?${params}`,
                    `https://data-live.flightradar24.com/zones/fcgi/feed.js?${params}`
                ];
                
                const proxify = (u) => [
                    u,
                    `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
                    `https://cors.isomorphic-git.org/${u}`
                ];
                
                for (const base of urls) {
                    const attempts = useProxy ? proxify(base) : [base];
                    for (const u of attempts) {
                        try {
                            const resp = await fetch(u, { 
                                cache: 'no-store', 
                                headers: { 'Accept': 'application/json, text/javascript, */*; q=0.01' } 
                            });
                            if (!resp.ok) continue;
                            const text = await resp.text();
                            let data = null;
                            try { 
                                data = JSON.parse(text); 
                            } catch (e) { 
                                data = eval('(' + text + ')'); 
                            }
                            if (data && typeof data === 'object') return data;
                        } catch (e) {
                            continue;
                        }
                    }
                }
                throw new Error('Failed to fetch FR24 data (CORS or network)');
            }

            function extractLatLon(arr) {
                for (let i = 0; i < arr.length - 1; i++) {
                    const a = Number(arr[i]);
                    const b = Number(arr[i + 1]);
                    if (isFinite(a) && isFinite(b) && a >= -90 && a <= 90 && b >= -180 && b <= 180) {
                        return { lat: a, lon: b, latIdx: i, lonIdx: i + 1 };
                    }
                }
                return null;
            }

            function parseFR24(data) {
                const result = [];
                let fullCount = 0;
                if (data.full_count) fullCount = Number(data.full_count) || 0;
                
                for (const [key, val] of Object.entries(data)) {
                    if (!Array.isArray(val)) continue;
                    const arr = val;
                    const ll = extractLatLon(arr);
                    if (!ll) continue;
                    
                    const lat = Number(ll.lat), lon = Number(ll.lon);
                    let heading = null, alt = null, spd = null, callsign = null, reg = null, acType = null, ts = Date.now();
                    
                    for (let i = 0; i < arr.length; i++) {
                        const v = arr[i];
                        if (typeof v === 'string') {
                            if (!callsign && /[A-Z0-9]{3,}/.test(v)) callsign = v.trim();
                            if (!reg && /[-A-Z0-9]{3,}/.test(v) && /^[A-Z0-9-]{3,}$/.test(v)) reg = v.trim();
                            if (!acType && /^[A-Z0-9]{3,4}$/.test(v) && i > ll.lonIdx + 3) acType = v.trim();
                        } else if (typeof v === 'number') {
                            if (i > ll.lonIdx && heading == null && v >= 0 && v <= 360) heading = Math.round(v);
                            if (i > ll.lonIdx && alt == null && v > 0 && v < 65000) alt = Math.round(v);
                            if (i > ll.lonIdx && spd == null && v >= 0 && v < 1200) spd = Math.round(v);
                        }
                    }
                    
                    const alt_m = alt != null ? feetToMeters(alt) : null;
                    const spd_kmh = spd != null ? toKmH(spd) : null;
                    
                    result.push({ 
                        hex: key, lat, lon, heading, alt_ft: alt, alt_m, spd_kmh, callsign, reg, acType, ts 
                    });
                }
                return { flights: result, fullCount };
            }

            function feetToMeters(ft) { 
                return Math.round(Number(ft) * 0.3048); 
            }

            function toKmH(knotsOrMs) {
                if (knotsOrMs == null || isNaN(knotsOrMs)) return null;
                const v = Number(knotsOrMs);
                if (v <= 0) return 0;
                if (v <= 250) { // likely m/s
                    return Math.round(v * 3.6);
                }
                return Math.round(v * 1.852);
            }

            function updateInfoTables(allFlights) {
                const counts = { 
                    passenger: 0, commercial: 0, private: 0, helicopter: 0, military: 0, drone: 0 
                };
                
                for (const f of allFlights) {
                    const cat = categorizeFlight(f);
                    if (counts[cat] != null) counts[cat]++;
                    else counts.commercial++;
                }
                
                document.getElementById('totalFlights').textContent = lastFullCount || allFlights.length;
                document.getElementById('countPassenger').textContent = counts.passenger;
                document.getElementById('countCommercial').textContent = counts.commercial;
                document.getElementById('countPrivate1').textContent = counts.private;
                document.getElementById('countHeli').textContent = counts.helicopter;
                document.getElementById('countMilitary').textContent = counts.military;
                document.getElementById('countDrones').textContent = counts.drone;
            }

            function update3DAircraft() {
                // Clear existing models
                aircraftModels.forEach((model, hex) => {
                    threeScene.remove(model);
                });
                aircraftModels.clear();
                
                // Add new models for current flights
                const labels = makeGroupLabels(Math.max(lastFullCount || 0, sortedHexes.length));
                const idx = labels.indexOf(currentGroup);
                const start = idx >= 0 ? idx * 20000 : 0;
                const end = start + 20000;
                const slice = sortedHexes.slice(start, end);
                
                slice.forEach(hex => {
                    const flightData = flightsByHex.get(hex);
                    if (flightData) {
                        createAircraftModel(flightData);
                    }
                });
            }

            function makeGroupLabels(total) {
                const size = 20000;
                const numGroups = Math.ceil(total / size);
                const labels = [];
                const alpha = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
                
                for (let i = 0; i < numGroups; i++) {
                    if (i < 26) {
                        labels.push(alpha[i]);
                    } else {
                        const first = Math.floor((i - 26) / 26);
                        const second = (i - 26) % 26;
                        labels.push(alpha[first] + alpha[second]);
                    }
                }
                return labels;
            }

            function refreshData() {
                if (isOpenSkyEnabled) {
                    fetchOpenSkyData();
                }
                fetchFR24Data();
            }

            function toggleAutoUpdate() {
                const autoUpdateSwitch = document.getElementById('autoUpdateSwitch');
                if (autoUpdateSwitch.checked) {
                    startAutoUpdate();
                } else {
                    stopAutoUpdate();
                }
            }

            function startAutoUpdate() {
                if (autoUpdateTimer) clearInterval(autoUpdateTimer);
                autoUpdateTimer = setInterval(() => {
                    refreshData();
                    updateAircraftPositions();
                }, 5000);
            }

            function stopAutoUpdate() {
                if (autoUpdateTimer) {
                    clearInterval(autoUpdateTimer);
                    autoUpdateTimer = null;
                }
            }

            function setGroupOptions(total) {
                const groupSelect = document.getElementById('groupSelect');
                const size = 20000;
                const numGroups = Math.ceil(total / size);
                const labels = [];
                const alpha = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
                
                for (let i = 0; i < numGroups; i++) {
                    if (i < 26) {
                        labels.push(alpha[i]);
                    } else {
                        const first = Math.floor((i - 26) / 26);
                        const second = (i - 26) % 26;
                        labels.push(alpha[first] + alpha[second]);
                    }
                }
                
                groupSelect.innerHTML = '';
                labels.forEach((lab, idx) => {
                    const opt = document.createElement('option');
                    opt.value = lab;
                    opt.textContent = `${lab} (${idx * 20000 + 1}â€“${(idx + 1) * 20000})`;
                    groupSelect.appendChild(opt);
                });
                groupSelect.value = currentGroup;
            }

            function updateMarkersAndTracks() {
                // Clear existing markers
                const markerLayer = map.getLayers().getArray().find(layer => layer.get('name') === 'markers');
                const trackLayer = map.getLayers().getArray().find(layer => layer.get('name') === 'tracks');
                
                if (markerLayer) markerLayer.getSource().clear();
                if (trackLayer) trackLayer.getSource().clear();
                
                if (sortedHexes.length === 0) return;
                
                const labels = makeGroupLabels(Math.max(lastFullCount || 0, sortedHexes.length));
                const idx = labels.indexOf(currentGroup);
                const start = idx >= 0 ? idx * 20000 : 0;
                const end = start + 20000;
                const slice = sortedHexes.slice(start, end);
                
                slice.forEach(hex => {
                    const flightData = flightsByHex.get(hex);
                    if (flightData) {
                        create2DMarker(flightData);
                    }
                });
            }

            function create2DMarker(flightData) {
                const markerLayer = map.getLayers().getArray().find(layer => layer.get('name') === 'markers');
                if (!markerLayer) return;
                
                const point = new ol.geom.Point(ol.proj.fromLonLat([flightData.lon, flightData.lat]));
                const feature = new ol.Feature({ 
                    geometry: point, 
                    hex: flightData.hex, 
                    data: flightData 
                });
                
                // Create style based on aircraft type
                const category = categorizeFlight(flightData);
                let style;
                
                if (category === 'military') {
                    style = new ol.style.Style({
                        image: new ol.style.Icon({
                            src: 'data:image/svg+xml;utf8,' + encodeURIComponent(`
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                                    <path fill="#4b1313" d="M12 2l3 5h5l-4 4 2 9-6-4-6 4 2-9-4-4h5z"/>
                                </svg>
                            `),
                            scale: 1.0,
                            rotation: (flightData.heading || 0) * Math.PI / 180
                        })
                    });
                } else if (category === 'helicopter') {
                    style = new ol.style.Style({
                        image: new ol.style.Icon({
                            src: 'data:image/svg+xml;utf8,' + encodeURIComponent(`
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                                    <path fill="#ffe34d" d="M3 12h10a4 4 0 110 8H8a5 5 0 01-5-5v-3zm14-6h-4a1 1 0 110-2h9a1 1 0 110 2h-3v5h-2V6z"/>
                                </svg>
                            `),
                            scale: 1.0
                        })
                    });
                } else {
                    const color = getAircraftColorHex(flightData);
                    style = new ol.style.Style({
                        image: new ol.style.Icon({
                            src: 'data:image/svg+xml;utf8,' + encodeURIComponent(`
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20">
                                    <path fill="${color}" d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/>
                                </svg>
                            `),
                            scale: 1.0,
                            rotation: (flightData.heading || 0) * Math.PI / 180
                        })
                    });
                }
                
                feature.setStyle(style);
                markerLayer.getSource().addFeature(feature);
            }

            function getAircraftColorHex(flightData) {
                const category = categorizeFlight(flightData);
                switch(category) {
                    case 'military': return '#4b1313';
                    case 'helicopter': return '#ffe34d';
                    case 'drone': return '#d21674';
                    case 'passenger': return '#4dacff';
                    case 'private': return '#b56dff';
                    default: return '#90ee90';
                }
            }

            function startDataFetching() {
                refreshData();
                startAutoUpdate();
            }

            // Make functions globally accessible
            window.selectAircraft = selectAircraft;
            window.toggle3DView = toggle3DView;
            window.toggleOpenSky = toggleOpenSky;

        })();
    </script>
</body>
</html>